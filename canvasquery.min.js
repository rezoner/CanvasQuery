/*     
  Canvas Query 0.6.0
  http://canvasquery.org
  (c) 2012-2013 http://rezoner.net
  Canvas Query may be freely distributed under the MIT license.
*/
(function(h){h.requestAnimationFrame=h.requestAnimationFrame||h.webkitRequestAnimationFrame||h.mozRequestAnimationFrame||h.oRequestAnimationFrame||h.msRequestAnimationFrame||function(a){h.setTimeout(a,1E3/60)};var d=function(a){if(0===arguments.length){var b=d.createCanvas(h.innerWidth,h.innerHeight);h.addEventListener("resize",function(){b.width=h.innerWidth;b.height=h.innerHeight})}else if("string"===typeof a)b=d.createCanvas(document.querySelector(a)[0]);else if("number"===typeof a)b=d.createCanvas(arguments[0],
arguments[1]);else if(a instanceof Image)b=d.createCanvas(a);else if(a instanceof HTMLCanvasElement)b=a;else if(a instanceof d.Wrapper)return a;return new d.Wrapper(b)};d.extend=function(){for(var a=1;a<arguments.length;a++)for(var b in arguments[a])arguments[0][b]=arguments[a][b];return arguments[0]};d.augment=function(){for(var a=1;a<arguments.length;a++)_.extend(arguments[0],arguments[a]),arguments[a](arguments[0])};d.extend(d,{keycodes:{37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",
8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"slash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebraket",222:"singlequote"},cleanArray:function(a,b){for(var c=arguments[arguments.length-
1],f="function"===typeof c,d=0,e=a.length;d<e;d++)if(null===a[d]||b&&a[d][b])f&&c(a[d]),a.splice(d--,1),e--},specialBlendFunctions:["color","value","hue","saturation"],blendFunctions:{normal:function(a,b){return b},overlay:function(a,b){a/=255;b/=255;return Math.min(255,Math.max(0,255*(128>a?2*a*b:1-2*(1-a)*(1-b))|0))},hardLight:function(a,b){return d.blendFunctions.overlay(b,a)},softLight:function(a,b){a/=255;b/=255;return d.limitValue(255*((1-2*b)*a*a+2*b*a),0,255)},dodge:function(a,b){return 256*
a/(255-b+1)},burn:function(a,b){return 255-256*(255-a)/(b+1)},multiply:function(a,b){return b*a/255},divide:function(a,b){return d.limitValue(256*a/(b+1),0,255)},screen:function(a,b){return 255-(255-b)*(255-a)/255},grainExtract:function(a,b){return d.limitValue(a-b+128,0,255)},grainMerge:function(a,b){return d.limitValue(a+b-128,0,255)},difference:function(a,b){return Math.abs(a-b)},addition:function(a,b){return Math.min(a+b,255)},substract:function(a,b){return Math.max(a-b,0)},darkenOnly:function(a,
b){return Math.min(a,b)},lightenOnly:function(a,b){return Math.max(a,b)},color:function(a,b){var c=d.rgbToHsl(a),f=d.rgbToHsl(b);return d.hslToRgb(f[0],f[1],c[2])},hue:function(a,b){var c=d.rgbToHsv(a),f=d.rgbToHsv(b);return f[1]?d.hsvToRgb(f[0],c[1],c[2]):d.hsvToRgb(c[0],c[1],c[2])},value:function(a,b){var c=d.rgbToHsv(a),f=d.rgbToHsv(b);return d.hsvToRgb(c[0],c[1],f[2])},saturation:function(a,b){var c=d.rgbToHsv(a),f=d.rgbToHsv(b);return d.hsvToRgb(c[0],f[1],c[2])}},blend:function(a,b,c,f){"undefined"===
typeof f&&(f=1);a=d(a);b=d(b);var j=b.context,e=a.context.getImageData(0,0,a.canvas.width,a.canvas.height);b=j.getImageData(0,0,b.canvas.width,b.canvas.height);e=e.data;b=b.data;var j=this.createImageData(a.canvas.width,a.canvas.height),g=j.data,m=d.blendFunctions[c];if(-1!==d.specialBlendFunctions.indexOf(c)){c=0;for(var n=e.length;c<n;c+=4){var h=m([e[c+0],e[c+1],e[c+2]],[b[c+0],b[c+1],b[c+2]]);g[c+0]=e[c+0]+(h[0]-e[c+0])*f;g[c+1]=e[c+1]+(h[1]-e[c+1])*f;g[c+2]=e[c+2]+(h[2]-e[c+2])*f;g[c+3]=e[c+
3]}}else{c=0;for(n=e.length;c<n;c+=4){var h=m(e[c+0],b[c+0]),k=m(e[c+1],b[c+1]),l=m(e[c+2],b[c+2]);g[c+0]=e[c+0]+(h-e[c+0])*f;g[c+1]=e[c+1]+(k-e[c+1])*f;g[c+2]=e[c+2]+(l-e[c+2])*f;g[c+3]=e[c+3]}}a.context.putImageData(j,0,0);return a},wrapValue:function(a,b,c){a<b?a=c+(a-b):a>c&&(a=b+(a-c));return a},limitValue:function(a,b,c){return a<b?b:a>c?c:a},mix:function(a,b,c){return a+(b-a)*c},hexToRgb:function(a){return["0x"+a[1]+a[2]|0,"0x"+a[3]+a[4]|0,"0x"+a[5]+a[6]|0]},rgbToHex:function(a,b,c){return"#"+
(16777216+(a<<16)+(b<<8)+c).toString(16).slice(1,7)},rgbToHsl:function(a,b,c){a instanceof Array&&(c=a[2],b=a[1],a=a[0]);a/=255;b/=255;c/=255;var f=Math.max(a,b,c),d=Math.min(a,b,c),e,g=(f+d)/2;if(f==d)e=d=0;else{var m=f-d,d=0.5<g?m/(2-f-d):m/(f+d);switch(f){case a:e=(b-c)/m+(b<c?6:0);break;case b:e=(c-a)/m+2;break;case c:e=(a-b)/m+4}e/=6}return[e,d,g]},hslToRgb:function(a,b,c){if(0==b)c=b=a=c;else{var f=function(a,b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*c:0.5>c?b:c<2/3?a+6*(b-a)*(2/3-
c):a},d=0.5>c?c*(1+b):c+b-c*b,e=2*c-d;c=f(e,d,a+1/3);b=f(e,d,a);a=f(e,d,a-1/3)}return[255*c|0,255*b|0,255*a|0]},rgbToHsv:function(a,b,c){a instanceof Array&&(c=a[2],b=a[1],a=a[0]);a/=255;b/=255;c/=255;var f=Math.max(a,b,c),d=Math.min(a,b,c),e,g=f-d;if(f==d)e=0;else{switch(f){case a:e=(b-c)/g+(b<c?6:0);break;case b:e=(c-a)/g+2;break;case c:e=(a-b)/g+4}e/=6}return[e,0==f?0:g/f,f]},hsvToRgb:function(a,b,c){var f,d,e,g=Math.floor(6*a),h=6*a-g;a=c*(1-b);var n=c*(1-h*b);b=c*(1-(1-h)*b);switch(g%6){case 0:f=
c;d=b;e=a;break;case 1:f=n;d=c;e=a;break;case 2:f=a;d=c;e=b;break;case 3:f=a;d=n;e=c;break;case 4:f=b;d=a;e=c;break;case 5:f=c,d=a,e=n}return[255*f,255*d,255*e]},color:function(){var a=new d.Color;a.parse(arguments);return a},createCanvas:function(a,b){var c=document.createElement("Canvas");a instanceof Image?(c.width=a.width,c.height=a.height,c.getContext("2d").drawImage(a,0,0)):(c.width=a,c.height=b);return c},createImageData:function(a,b){return document.createElement("Canvas").getContext("2d").createImageData(a,
b)}});d.Wrapper=function(a){this.context=a.getContext("2d");this.canvas=a};d.Wrapper.prototype={appendTo:function(a){("object"===typeof a?a:document.querySelector(a)).appendChild(this.canvas);return this},blendOn:function(a,b,c){d.blend(a,this,b,c);return this},blend:function(a,b,c){if("string"===typeof a){var f=a;a=d(d.createCanvas(this.canvas.width,this.canvas.height));a.fillStyle(f).fillRect(0,0,this.canvas.width,this.canvas.height)}d.blend(this,a,b,c);return this},crop:function(a,b,c,d){this.context.drawImage(this.canvas,
a,b,c,d,0,0,c,d);this.canvas.width=c;this.canvas.height=d;return this},colorToMask:function(a){a=d.color(a).toArray();for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data,c=[],f=0,j=b.length;f<j;f+=4)b[f+0]==a[0]&&b[f+1]==a[1]&&b[f+2]==a[2]?c.push(!1):c.push(!0);return c},applyMask:function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,d=0,j=c.length;d<j;d+=4)a[d/4]||(c[d+3]=0);this.context.putImageData(b,0,0);return this},
fillMask:function(a,b){b=this.color(b);for(var c=this.context.getImageData(0,0,sourceCanvas.width,sourceCanvas.height),d=c.data,j=0,e=d.length;j<e;j+=4)a[j/4]||(d[j+0]=b[0],d[j+1]=b[1],d[j+2]=b[2],d[j+3]=b[3]);this.context.putImageData(c,0,0);return this},clear:function(a){a?(this.context.fillStyle=a,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)):this.context.clearRect(0,0,this.canvas.width,this.canvas.height);return this},clone:function(){var a=d.createCanvas(this.canvas.width,
this.canvas.height);a.getContext("2d").drawImage(this.canvas,0,0);return d(a)},fillStyle:function(a){this.context.fillStyle=a;return this},strokeStyle:function(a){this.context.strokeStyle=a;return this},setHsl:function(){var a=1===arguments.length?arguments[0]:arguments,b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,f,j,e;e=[];f=[];for(var g=0,h=c.length;g<h;g+=4)e=d.rgbToHsl(c[g+0],c[g+1],c[g+2]),f=null===a[0]?e[0]:d.limitValue(a[0],0,1),j=null===a[1]?e[1]:d.limitValue(a[1],
0,1),e=null===a[2]?e[2]:d.limitValue(a[2],0,1),f=d.hslToRgb(f,j,e),c[g+0]=f[0],c[g+1]=f[1],c[g+2]=f[2];this.context.putImageData(b,0,0);return this},shiftHsl:function(){var a=1===arguments.length?arguments[0]:arguments,b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,f,j,e;e=[];f=[];for(var g=0,h=c.length;g<h;g+=4)e=d.rgbToHsl(c[g+0],c[g+1],c[g+2]),f=null===a[0]?e[0]:d.wrapValue(e[0]+a[0],0,1),j=null===a[1]?e[1]:d.limitValue(e[1]+a[1],0,1),e=null===a[2]?e[2]:d.limitValue(e[2]+
a[2],0,1),f=d.hslToRgb(f,j,e),c[g+0]=f[0],c[g+1]=f[1],c[g+2]=f[2];this.context.putImageData(b,0,0);return this},convolute:function(a,b,c){"undefined"===typeof c&&(c=1);"undefined"===typeof b&&(b=1);for(var f=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),j=Math.sqrt(a.length)+0.5|0,e=j/2|0,g=f.data,h=f.width,f=f.height,n=d.createImageData(this.canvas.width,this.canvas.height),k=n.data,l=1;l<f-1;l++)for(var p=1;p<h-1;p++){for(var q=4*(l*h+p),v=0,w=0,x=0,t=0;t<j;t++)for(var u=0;u<
j;u++){var r=l+t-e,s=p+u-e;0<=r&&(r<f&&0<=s&&s<h)&&(r=4*(r*h+s),s=a[t*j+u]/c,v+=g[r+0]*s,w+=g[r+1]*s,x+=g[r+2]*s)}k[q+0]=d.mix(g[q+0],v,b);k[q+1]=d.mix(g[q+1],w,b);k[q+2]=d.mix(g[q+2],x,b);k[q+3]=g[q+3]}this.context.putImageData(n,0,0);return this},blur:function(a){return this.convolute([1,1,1,1,1,1,1,1,1],a,9)},gaussianBlur:function(a){return this.convolute([6.7E-7,2.292E-5,1.9117E-4,3.8771E-4,1.9117E-4,2.292E-5,6.7E-7,2.292E-5,7.8633E-4,0.00655965,0.01330373,0.00655965,7.8633E-4,2.292E-5,1.9117E-4,
0.00655965,0.05472157,0.11098164,0.05472157,0.00655965,1.9117E-4,3.8771E-4,0.01330373,0.11098164,0.22508352,0.11098164,0.01330373,3.8771E-4,1.9117E-4,0.00655965,0.05472157,0.11098164,0.05472157,0.00655965,1.9117E-4,2.292E-5,7.8633E-4,0.00655965,0.01330373,0.00655965,7.8633E-4,2.292E-5,6.7E-7,2.292E-5,1.9117E-4,3.8771E-4,1.9117E-4,2.292E-5,6.7E-7],a,9)},sharpen:function(a){return this.convolute([0,-1,0,-1,5,-1,0,-1,0],a)},threshold:function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,
this.canvas.height),c=b.data,d,h,e,g=0;g<c.length;g+=4)d=c[g],h=c[g+1],e=c[g+2],c[g]=c[g+1]=c[g+2]=0.2126*d+0.7152*h+0.0722*e>=a?255:0;this.context.putImageData(b,0,0);return this},sepia:function(){for(var a=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=a.data,c=0;c<b.length;c+=4)b[c+0]=d.limitValue(0.393*b[c+0]+0.769*b[c+1]+0.189*b[c+2],0,255),b[c+1]=d.limitValue(0.349*b[c+0]+0.686*b[c+1]+0.168*b[c+2],0,255),b[c+2]=d.limitValue(0.272*b[c+0]+0.534*b[c+1]+0.131*b[c+2],0,255);
this.context.putImageData(a,0,0);return this},onStep:function(a,b){var c=this,d=Date.now();this.timer=setInterval(function(){var b=Date.now()-d;a.call(c,b);d=Date.now()},b);return this},onRender:function(a){function b(){requestAnimationFrame(b);a.call(c)}var c=this;requestAnimationFrame(b);return this},onMouseMove:function(a){var b=this;this.canvas.addEventListener("mousemove",function(c){a.call(b,c.layerX,c.layerY)});return this},onMouseDown:function(a){var b=this;this.canvas.addEventListener("mousemove",
function(c){a.call(b,c.layerX,c.layerY,c.button)});return this},onMouseUp:function(a){var b=this;this.canvas.addEventListener("mousemove",function(c){a.call(b,c.layerX,c.layerY,c.button)});return this},onKeyDown:function(a){document.addEventListener("keydown",function(b){b=48<=b.which&&90>=b.which?String.fromCharCode(b.which).toLowerCase():d.keycodes[b.which];a.call(self,b)});return this},onKeyUp:function(a){document.addEventListener("keyup",function(b){b=48<=b.which&&90>=b.which?String.fromCharCode(b.which).toLowerCase():
d.keycodes[b.which];a.call(self,b)});return this},onResize:function(a){var b=this;h.addEventListener("resize",function(){a.call(b,h.innerWidth,h.innerHeight)});a.call(b,h.innerWidth,h.innerHeight);return this}};for(var p="arc arcTo beginPath bezierCurveTo clearRect clip closePath createImageData createLinearGradient createRadialGradient createPattern drawFocusRing drawImage fill fillRect fillText getImageData isPointInPath lineTo measureText moveTo putImageData quadraticCurveTo rect restore rotate save scale setTransform stroke strokeRect strokeText transform translate".split(" "),
k=0;k<p.length;k++){var l=p[k];d.Wrapper.prototype[l]=Function("this.context."+l+".apply(this.context, arguments); return this;")}p="canvas fillStyle font globalAlpha globalCompositeOperation lineCap lineJoin lineWidth miterLimit shadowOffsetX shadowOffsetY shadowBlur shadowColor strokeStyle textAlign textBaseline".split(" ");for(k=0;k<p.length;k++)l=p[k],d.Wrapper.prototype[l]=Function("if(arguments.length) { this.context."+l+" = arguments[0]; return this; } else { return this.context."+l+"; }");
d.Color=function(){arguments.length&&this.parse(arguments)};d.Color.prototype={parse:function(a){if("string"===typeof a[0]){var b=d.hexToRgb(a[0]);this[0]=b[0];this[1]=b[1];this[2]=b[2];this[3]="undefined"===typeof a[1]?1:a[1]}else this[0]=a[0],this[1]=a[1],this[2]=a[2],this[3]="undefined"===typeof a[3]?1:a[3]},toArray:function(){return[this[0],this[1],this[2],this[3]]},toRgb:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+")"},toRgba:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+
", "+this[3]+")"},toHex:function(){return d.rgbToHex(this[0],this[1],this[2])},toHsl:function(){return d.rgbToHsl(this[0],this[1],this[2])},toHsv:function(){return d.rgbToHsv(this[0],this[1],this[2])}};h.cq=h.CanvasQuery=d;"function"===typeof define&&define.amd&&define([],function(){return d})})(window);